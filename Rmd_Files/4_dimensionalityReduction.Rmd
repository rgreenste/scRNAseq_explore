---
title: "Dimensionality Reduction and Plotting"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Dependencies

Load the major packages needed for this analysis first. Additional packages will be loaded as needed.

```{r, message=FALSE, warning=FALSE, echo = TRUE}
# dependencies needed
library(SingleCellExperiment)
library(scater)
library(scran)
library(uwot)
library(Rtsne)
```

Loading the files which were output by "3_Normalization.Rmd"
```{r, echo = TRUE}

filtered<-readRDS( file="../processed_data/guiu_filtered_normalized.rds")
filtered.var<-readRDS(file="../processed_data/filtered.var.rds")
top.genes.varFDR<-readRDS( file="../processed_data/top.genes.varFDR.rds") 
 

```

## Dimensionality Reduction by PCA and tSNE


```{r, echo=TRUE}
# perform PCA for dimension reduction with 
set.seed(101)
filtered.denoised <- denoisePCA(filtered, 
                                subset.row=top.genes.varFDR, 
                                technical=filtered.var)
# convert rownames to gene symbol
rownames(filtered.denoised)<-rowData(filtered.denoised)$Symbol

# perform tSNE for further dimension reduction
set.seed(102)
filtered.denoised <- runTSNE(filtered.denoised, dimred="PCA")


```

## Clustering

```{r, echo=TRUE}


g <- buildSNNGraph(filtered.denoised, k=10, use.dimred = 'PCA')
clust <- igraph::cluster_walktrap(g)$membership
table(clust)
filtered.denoised$cluster <- factor(clust)
plotReducedDim(filtered.denoised, dimred="TSNE", colour_by="cluster")

```

## Examining expression of marker genes across the population


![Extended Data Fig 3a from Guiu et al.](../guiu_etal_ExtData3A.png)
t-SNE plots of epithelial cells from the proximal small intestine showing expression of intestinal stem-cell (Lgr5) and differentiation markers (Muc2, Lyz1, ChgA and Alpi.)

```{r, message = FALSE, warning = FALSE, echo=TRUE, fig.height= 8, fig.width=7}
diffMarkers<-c("Lgr5", "Muc2", "Lyz1", "Chga", "Alpi")

gridExtra::grid.arrange(
  plotReducedDim(filtered.denoised, dimred="TSNE", colour_by=diffMarkers[1]) +
    ggtitle(diffMarkers[1]),
  plotReducedDim(filtered.denoised, dimred="TSNE", colour_by=diffMarkers[2]) +
    ggtitle(diffMarkers[2]),
  plotReducedDim(filtered.denoised, dimred="TSNE", colour_by=diffMarkers[3]) +
    ggtitle(diffMarkers[3]),
  plotReducedDim(filtered.denoised, dimred="TSNE", colour_by= diffMarkers[4]) +
    ggtitle(diffMarkers[4]),
  plotReducedDim(filtered.denoised, dimred="TSNE", colour_by= diffMarkers[5]) +
    ggtitle(diffMarkers[5]),
  ncol=2
)
```



```{r, echo = TRUE, warning=FALSE}
library(SingleR)
ref <- MouseRNAseqData()	
pred <- SingleR(test=filtered.denoised, ref=ref, labels=ref$label.main)
table(pred$labels)
filtered.denoised2<-filtered.denoised
filtered.denoised2$anno <- factor(pred$labels)
plotReducedDim(filtered.denoised2, dimred="TSNE", colour_by="anno")
```

Save the resulting files

```{r, echo=TRUE}

saveRDS(filtered.denoised, file="../processed_data/guiu_filtered_denoised.rds") 
saveRDS(filtered.denoised2, file="../processed_data/guiu_filtered_denoised2.rds") 
```


```{r}
sessionInfo()
```
